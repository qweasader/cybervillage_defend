<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6a11cb">
    <meta name="backend-url" content="https://refreshing-nourishment-production-e7ce.up.railway.app/">
    
    <title>–ó–µ—Ä–∫–∞–ª–æ –ò—Å—Ç–∏–Ω—ã</title>
    <link rel="stylesheet" href="../style.css">
    <script src="../telegram.js" defer></script>
    <script src="../game.js" defer></script>
</head>
<body>
    <div class="container">
        <header>
            <button class="back-button" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="location-title">ü™û –ó–µ—Ä–∫–∞–ª–æ –ò—Å—Ç–∏–Ω—ã</div>
            <div class="user-avatar-small" id="userAvatar">üë§</div>
        </header>

        <main>
            <div class="location-content">
                <div class="location-image">
                    <div class="location-emoji">ü™û</div>
                </div>

                <div class="password-section">
                    <h2>üîë –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞</h2>
                    <p class="password-desc">–ü–∞—Ä–æ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –ª–æ–∫–∞—Ü–∏–∏. –ù–∞–π–¥–∏—Ç–µ –µ–≥–æ –∏ –≤–≤–µ–¥–∏—Ç–µ –∑–¥–µ—Å—å.</p>
                    
                    <input type="text" id="passwordInput" class="password-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å..." maxlength="20">
                    <button class="submit-button" id="submitBtn">–†–∞–∑–±–∏—Ç—å –∏–ª–ª—é–∑–∏—é</button>
                </div>

                <div class="mission-section" id="missionSection" style="display: none;">
                    <h2>üéØ –ó–∞–¥–∞–Ω–∏–µ</h2>
                    <div id="missionContent" class="mission-content">
                        <!-- –ó–∞–¥–∞–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>

                    <div class="answer-section">
                        <h3>üîë –í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç</h3>
                        <input type="text" id="answerInput" class="answer-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." maxlength="50">
                        <button class="submit-button" id="answerBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                    </div>
                </div>

                <div class="hint-section">
                    <button class="hint-button" id="hintBtn">
                        üí° –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É <span id="hintCounter"></span>
                    </button>
                </div>
            </div>
        </main>

        <footer>
            <p>–ó–∞—â–∏—Ç–∞ –ö–∏–±–µ—Ä–¥–µ—Ä–µ–≤–Ω–∏ ‚Ä¢ –õ–æ–∫–∞—Ü–∏—è 3 –∏–∑ 6</p>
        </footer>
    </div>

    <script>
        const locationId = 'mirror';
        let missionData = null;
        let passwordVerified = false;

        document.addEventListener('telegramReady', async (event) => {
            const { userData } = event.detail;
            
            if (userData) {
                document.getElementById('userAvatar').textContent = userData.firstName?.[0] || 'üë§';
            }

            if (gameEngine.completedLocations.has(locationId)) {
                showMissionSection();
                loadMission();
                passwordVerified = true;
            }

            updateHintCounter();
        });

        document.getElementById('submitBtn').addEventListener('click', async () => {
            const password = document.getElementById('passwordInput').value.trim();
            
            if (!password) {
                tgApp.showAlert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            const result = await tgApp.checkLocationPassword(locationId, password);
            
            if (result.success) {
                passwordVerified = true;
                tgApp.showAlert('‚úÖ –ü–∞—Ä–æ–ª—å –≤–µ—Ä–Ω—ã–π! –ò–ª–ª—é–∑–∏—è —Ä–∞–∑–±–∏—Ç–∞!', () => {
                    showMissionSection();
                    loadMission();
                });
            } else {
                tgApp.showAlert(`‚ùå ${result.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!'}`);
            }
        });

        async function loadMission() {
            missionData = await tgApp.getMission(locationId);
            
            if (!missionData) {
                document.getElementById('missionContent').innerHTML = `
                    <p>‚ö†Ô∏è –ó–∞–¥–∞–Ω–∏–µ –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</p>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º–∏.</p>
                `;
                return;
            }

            document.getElementById('missionContent').innerHTML = `
                <p>${missionData.text || '–ó–∞–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ'}</p>
                ${missionData.imageUrl ? `<img src="${missionData.imageUrl}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" class="mission-image">` : ''}
            `;
        }

        function showMissionSection() {
            document.querySelector('.password-section').style.display = 'none';
            document.getElementById('missionSection').style.display = 'block';
        }

        document.getElementById('answerBtn').addEventListener('click', async () => {
            const answer = document.getElementById('answerInput').value.trim().toLowerCase();
            
            if (!answer) {
                tgApp.showAlert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç!');
                return;
            }

            if (!missionData) {
                tgApp.showAlert('‚ö†Ô∏è –ó–∞–¥–∞–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!');
                return;
            }

            const correctAnswer = missionData.answer?.toLowerCase();
            
            if (answer === correctAnswer) {
                await tgApp.sendGameEvent('location_completed', {
                    location: locationId,
                    locationName: tgApp.getLocationName(locationId),
                    answer: answer
                });

                gameEngine.markLocationCompleted(locationId);
                
                tgApp.showAlert('üéâ –û—Ç–ª–∏—á–Ω–æ! –õ–æ–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞!', () => {
                    window.location.href = '../index.html';
                });
            } else {
                tgApp.showAlert('‚ùå –ù–µ–≤–µ—Ä–Ω–æ! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫—É.');
            }
        });

        document.getElementById('hintBtn').addEventListener('click', async () => {
            if (!passwordVerified) {
                tgApp.showAlert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞!');
                return;
            }

            const hint = await tgApp.requestHint(locationId);
            
            if (hint) {
                tgApp.showAlert(`üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:\n${hint.text}`);
                updateHintCounter();
            }
        });

        function updateHintCounter() {
            const hintsLeft = gameEngine.getHintsLeft();
            document.getElementById('hintCounter').textContent = `(${hintsLeft} –æ—Å—Ç–∞–ª–æ—Å—å)`;
        }

        document.getElementById('backBtn').addEventListener('click', () => {
            window.history.back();
        });

        document.getElementById('passwordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('submitBtn').click();
            }
        });

        document.getElementById('answerInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('answerBtn').click();
            }
        });
    </script>
</body>
</html>
